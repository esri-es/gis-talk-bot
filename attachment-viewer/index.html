<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Ejemplo 8: Mostrar un escenario 3D</title>
  <meta name="description" content="Este ejemplo usa la <a href='https://developers.arcgis.com/javascript/beta/'>versión 4.0</a> (aún en beta) para mostrar un escenario en 3 dimensiones." />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <base href="//www.jsviews.com/samples/" />
  <script src="../download/jsrender.min.js"></script>
  <link href="samples.css" rel="stylesheet" />
  <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.0.0-beta.30/css/calcite-web.min.css">
    <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.0.0-beta.30/js/calcite-web.min.js"></script>
    <script>
      window.onload = function () {calcite.init();};
    </script>

  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }

    #viewDiv{
        width: 100%;
        height: 50%;
    }

    #result, #result li{
        margin: 0;
        list-style: none;
    }
    #result li{
        display: inline-block;
        width: 25%;
        float: left;
        height: 150px;
    }
    .image{
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        box-sizing: border-box;
        cursor: pointer;
    }
    .container-fill{
        height: 100%;
    }
    .container-top{
        height: 10%;
    }
    .container-bottom{
        height: 80%;
        overflow: scroll;
    }
    .selected{
        border: 3px solid yellow;
    }

  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
  <script src="https://js.arcgis.com/4.6/"></script>

  <script>
    var map, view;

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/geometry/Point",
      "esri/Graphic",
      "dojo/dom",
      "dojo/on",
      "dojo/domReady!"
  ], function(Map, MapView, Point, Graphic, dom, on) {

      // Creamos el mapa
      map = new Map({
        basemap: "hybrid"
      });

      // Creamos la vista
      view = new MapView({
        map: map,
        container: "viewDiv",
        center: [-3.674, 40.439],
        zoom: 17
      });




      window.showImage = function(el, id){

          var feature = `${featureUrl}/query?where=${objectIdField}+%3D+${id}&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=*&returnGeometry=true&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=3857&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnDistinctValues=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=json&token=`;
          console.log(feature)

          $("ul .selected").removeClass("selected");
          $(el).addClass("selected")

          $.getJSON( feature, function( data ) {

              point = new Point({
                  "x": data.features[0].geometry.x,
                "y": data.features[0].geometry.y,
                spatialReference: 3857
              })



                    // Create a graphic and add the geometry and symbol to it
                    var pointGraphic = new Graphic({
                      geometry: point,
                      symbol: {
                        type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
                        color: [226, 119, 40],
                        outline: { // autocasts as new SimpleLineSymbol()
                          color: [255, 255, 255],
                          width: 2
                        }
                      }
                    });

              view.graphics.add(pointGraphic)

              view.goTo(point);
          });
      }



    });
  </script>
</head>

<body>


    <div class="grid-container container-fill">
      <div class="column-24 container-top">
        <!-- desktop sized navigation -->
        <div class="tablet-hide">
          <!-- logo / home -->
          <a href="#" class="top-nav-title">Feature attachments</a>

        </div>

      </div>
      <div class="column-16 container-bottom">
          <ul id="result"></ul>
</div>
<div class="column-8 container-bottom">
    <div id="viewDiv"></div>
</div>

    </div>





  <script id="theTmpl" type="text/x-jsrender">
  <li>

  <div class="image" style="background-image:url({{:url}})" data-parentobjectid="{{:parentObjectId}}" onclick="showImage(this, {{:parentObjectId}})"></div>

  </li>
  </script>

  <script>

  var template = $.templates("#theTmpl");



  featureUrl = getUrlParams();
  if(featureUrl){
      featureUrl = featureUrl.url;
  }else{
      //var featureUrl = 'https://services.arcgis.com/0ZRg6WRC7mxSLyKX/arcgis/rest/services/harveyDamagePhotos/FeatureServer/0';
      var featureUrl = 'https://services2.arcgis.com/lakDP2oKmBnm3KDC/ArcGIS/rest/services/Prueba_20140804_061021/FeatureServer/0';
      //var featureUrl = 'https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/NPSMemories/FeatureServer/0'
  }
  var objectIdField = null;

  $.getJSON( `${featureUrl}?f=json`, function( data ) {
      objectIdField = data.objectIdField
  });

  $.getJSON( `${featureUrl}/queryAttachments?objectIds=&globalIds=&definitionExpression=1+%3D+1&attachmentTypes=&size=&resultOffset=&resultRecordCount=&f=pjson&token=`, function( data ) {
      var attachments = [],
      attachments_thumb = [];
      data.attachmentGroups.forEach(function(elem,i){
          elem.attachmentInfos.forEach(function(attachment,j){
              var tmp = `${featureUrl}/${elem.parentObjectId}/attachments/${attachment.id}`;
              //console.log(tmp);

                  attachments.push({
                      parentObjectId: elem.parentObjectId,
                      GlobalID: attachment.GlobalID,
                      url: tmp
                  });

          });
      });


      var htmlOutput = template.render(attachments);
      $("#result").html(htmlOutput);

  });


  function getUrlParams() {
    var search = location.search.substring(1);
    if(search){
        var obj = decodeURI(search).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"');
        return JSON.parse('{"' + obj  + '"}');
    }else{
        return false;
    }
}



  </script>

</body>
</html>
